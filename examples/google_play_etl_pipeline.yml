# Google Play Data ETL Pipeline
pipeline_name: google_play_financial_etl
tags: [daily, google_play, revenue]

# Variables for date range (incremental processing)
variables:
  start_date: "{{ state.get('last_processed_date', days_ago(30)) }}"
  end_date: "{{ yesterday() }}"

steps:
  # Step 1: Extract financial data from Google Play Console
  - id: extract_google_play_financials
    type: source
    source_type: google_play
    config:
      package_name: "{{ env_var('GOOGLE_PLAY_PACKAGE_NAME') }}"
      service_account_file: "{{ env_var('GOOGLE_PLAY_SERVICE_ACCOUNT_FILE') }}"
      report_type: "financial"
      start_date: "{{ var('start_date') }}"
      end_date: "{{ var('end_date') }}"
  
  # Step 2: Validate extracted data
  - id: validate_financial_data
    type: processor
    processor_type: validator
    depends_on: [extract_google_play_financials]
    config:
      required_columns: [date, revenue_usd, transactions, currency, country]
      row_count_min: 1
      schema_check: true
      
  # Step 3: Save raw data to ClickHouse
  - id: save_raw_financials
    type: endpoint
    endpoint_type: clickhouse
    depends_on: [validate_financial_data]
    config:
      table: "google_play_financials_raw"
      auto_create: true
      mode: "append"
      schema:
        date: "Date"
        revenue_usd: "Float64"
        transactions: "UInt32"
        currency: "String"
        country: "String"
        product_id: "String"
        loaded_at: "DateTime DEFAULT now()"
        
  # Step 4: Extract installs data from Google Play Console  
  - id: extract_google_play_installs
    type: source
    source_type: google_play
    config:
      package_name: "{{ env_var('GOOGLE_PLAY_PACKAGE_NAME') }}"
      service_account_file: "{{ env_var('GOOGLE_PLAY_SERVICE_ACCOUNT_FILE') }}"
      report_type: "installs"
      start_date: "{{ var('start_date') }}"
      end_date: "{{ var('end_date') }}"
      
  # Step 5: Validate installs data
  - id: validate_installs_data
    type: processor
    processor_type: validator
    depends_on: [extract_google_play_installs]
    config:
      required_columns: [date, installs, uninstalls, net_installs, country]
      row_count_min: 1
      
  # Step 6: Save installs data to ClickHouse
  - id: save_installs_data
    type: endpoint
    endpoint_type: clickhouse
    depends_on: [validate_installs_data]
    config:
      table: "google_play_installs"
      auto_create: true
      mode: "append"
      schema:
        date: "Date"
        installs: "UInt32"
        uninstalls: "UInt32"
        net_installs: "Int32"
        country: "String"
        source: "String"
        loaded_at: "DateTime DEFAULT now()"