# User Cohort Analysis Pipeline  
pipeline_name: user_cohorts
tags: [weekly, cohorts, analysis]

# Run weekly cohort analysis
variables:
  # Process full weeks only
  start_date: "{{ state.get('last_processed_date', days_ago(14)) }}"
  end_date: "{{ last_monday() }}"  # End on last Monday to have complete weeks

steps:
  # Get user registration data
  - id: extract_user_registrations
    type: source
    source_type: postgresql  
    name: main_postgres
    config:
      query: |
        SELECT 
          user_id,
          DATE(registration_date) as registration_date,
          country_code,
          acquisition_channel,
          DATE_TRUNC('week', registration_date) as cohort_week
        FROM users
        WHERE registration_date BETWEEN '{{ var("start_date") }}' AND '{{ var("end_date") }}'
        AND country_code IN ({{ var("core_countries")|join("','") }})

  # Get user activity data for cohort analysis
  - id: extract_user_activity
    type: source
    source_type: postgresql
    name: main_postgres  
    config:
      query: |
        SELECT 
          user_id,
          DATE(activity_date) as activity_date,
          sessions,
          revenue_usd
        FROM user_daily_stats
        WHERE activity_date BETWEEN '{{ var("start_date") }}' AND '{{ var("end_date") }}'
        AND user_id IN (
          SELECT user_id FROM users 
          WHERE registration_date >= '{{ var("start_date") }}' - INTERVAL '90 days'
        )

  # Validate cohort data
  - id: validate_cohort_data  
    type: processor
    processor_type: validator
    depends_on: [extract_user_registrations]
    config:
      required_columns: [user_id, registration_date, cohort_week]
      row_count_min: 100  # Need meaningful cohort sizes

  # Save cohort data
  - id: save_cohort_registrations
    type: endpoint
    endpoint_type: clickhouse
    name: analytics_warehouse
    depends_on: [validate_cohort_data]
    config:
      table: "user_cohorts_raw"
      auto_create: true
      mode: "append"

  # Save activity data  
  - id: save_cohort_activity
    type: endpoint
    endpoint_type: clickhouse
    name: analytics_warehouse
    depends_on: [extract_user_activity]
    config:
      table: "user_activity_raw"
      auto_create: true
      mode: "append"